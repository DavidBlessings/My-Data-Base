<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sagittarius Security Management System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: system-ui,sans-serif; background: #f6f8fa; }
    .container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 240px; background: blue; color: #fff; display: flex; flex-direction: column;
      padding: 2rem 1rem; min-height: 100vh;
    }
    .sidebar-title { font-size: 18; font-weight: bold; margin-bottom: 2.5rem; text-align: center; }
    .sidebar-links { list-style: none; padding: 0; margin: 0; }
    .sidebar-link {
      display: block; color: #c8d1e1; padding: 0.9rem 1.2rem; border-radius: 0.4rem;
      text-decoration: none; margin-bottom: 0.7rem; font-size: 1.06rem;
      transition: background 0.2s, color 0.2s; cursor: pointer;
    }
    .sidebar-link.active, .sidebar-link:hover { background: brown; color: #fff; }
    .main-content { flex: 1; padding: 2rem; background: #f6f8fa; overflow-y: auto; position: relative; }
    .dashboard-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; gap: 1.5rem;
    }
    .dashboard-header h1 { margin: 0; }
    .timestamp {
      color: blue; font-size: 16; background: #e9edf6;
      padding: 0.35rem 0.9rem; border-radius: 1.2rem; box-shadow: 0 2px 8px rgba(30,40,55,0.05);
      font-weight: bold; display: inline-flex; align-items: center; gap: 0.4rem;
      margin-bottom: 1rem;
      font-style: italic;
    }
    .dashboard-metrics {
      display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap;
    }
    .metric-card {
      box-shadow: 0 2px 8px rgba(30,40,55,0.08); border-radius: 0.8rem; padding: 1.1rem 1.6rem; flex: 1 1 160px;
      min-width: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff;
    }
    .metric-card.users { background: linear-gradient(135deg, #2a5298 60%, #1e3c72 100%); }
    .metric-card.guards { background: linear-gradient(135deg, #27ae60 60%, #219150 100%); }
    .metric-card.locations { background: linear-gradient(135deg, #f39c12 60%, #e67e22 100%); }
    .metric-card.incidents { background: linear-gradient(135deg, #e74c3c 60%, #c0392b 100%); }
    .metric-value { font-size: 1.6rem; font-weight: bold; margin-bottom: 0.2rem; }
    .metric-label { font-size: 0.99rem; color: rgba(255,255,255,0.9); }
    .chart-section { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #e3e7ef; margin-bottom: 1.8rem; padding: 1.2rem 1.2rem 1.5rem 1.2rem;}
    .chart-title { color: #274472; font-weight: 600; margin-bottom: 0.5rem; }
    .users-table, .incidents-table, .logs-table, .guards-table {
      width: 100%; border-collapse: collapse; margin-top: 1.2rem; background: #fff; box-shadow: 0 2px 8px #e3e7ef;
      border-radius: 9px; overflow: hidden; font-size: 1.01rem;
    }
    .users-table thead, .incidents-table thead, .logs-table thead, .guards-table thead { background: #f6f8fa; color: #274472; }
    .users-table th, .users-table td, .incidents-table th, .incidents-table td, .logs-table th, .logs-table td, .guards-table th, .guards-table td {
      padding: 8px 10px; border-bottom: 1px solid #e3e7ef; text-align: left;
    }
    .users-table th, .incidents-table th, .logs-table th, .guards-table th { font-weight: 600; }
    .users-table tr:last-child td, .incidents-table tr:last-child td, .logs-table tr:last-child td, .guards-table tr:last-child td { border-bottom: none; }
    .users-table tbody tr:hover, .incidents-table tbody tr:hover, .logs-table tbody tr:hover, .guards-table tbody tr:hover { background: #f9f2f2; }
    .users-table .action-btns, .incidents-table .action-btns, .guards-table .action-btns { display: flex; gap: 7px; }
    .users-table .btn-action, .incidents-table .btn-action, .guards-table .btn-action {
      border: none; background: #e9edf6; color: #274472; padding: 4px 11px; border-radius: 4px;
      cursor: pointer; font-size: 0.98rem; font-weight: 600; transition: background 0.16s, color 0.16s;
    }
    .users-table .btn-action.edit, .incidents-table .btn-action.edit, .guards-table .btn-action.edit { background: #f39c12; color: #fff;}
    .users-table .btn-action.delete, .incidents-table .btn-action.delete, .guards-table .btn-action.delete { background: #e74c3c; color: #fff;}
    .guards-table .btn-action.shift { background: #274472; color: #fff;}
    .guards-table .btn-action.duty-on { background: #27ae60; color: #fff;}
    .guards-table .btn-action.duty-off { background: #e74c3c; color: #fff;}
    .users-table .btn-action.call, .guards-table .btn-action.call { background: #27ae60; color: #fff;}
    .map-marker { color: #e74c3c; font-size: 1.2rem; margin-right: 4px; vertical-align: middle;}
    .report-download-btn { background: #274472; color: #fff; border: none; border-radius: 5px; padding: 7px 16px; font-size: 1.02rem; margin-bottom: 1.2rem; margin-right: 10px; cursor: pointer; font-weight: 600; transition: background 0.16s;}
    .report-download-btn:hover { background: #2a5298;}
    .modal-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30,40,55,0.18); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .modal { background: #fff; border-radius: 1rem; box-shadow: 0 8px 36px rgba(30,40,55,0.14); padding: 2rem 2rem 1.5rem 2rem; max-width: 400px; width: 98vw; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal label { font-weight: 500; display: block; margin: 1rem 0 0.12rem 0; color: #274472;}
    .modal input, .modal textarea, .modal select { width: 100%; padding: 7px 8px; border-radius: 5px; border: 1px solid #c8d1e1; font-size: 1.04rem; margin-bottom: 0.3rem; box-sizing: border-box; background: #f6f8fa; resize: vertical;}
    .modal .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;}
    .modal .modal-actions button { padding: 8px 20px; border-radius: 5px; border: none; font-size: 1.05rem; background: #274472; color: #fff; cursor: pointer;}
    .modal .modal-actions button.cancel { background: #bbb; color: #274472;}
    .modal .form-error { color: #e74c3c; font-size: 0.98rem; margin-bottom: 0.4rem; margin-top: 0.2rem;}
    .leaflet-container { height: 120px; width: 100%; margin: 0.4rem 0 0.3rem 0; border-radius: 8px; }
    .duty-dot { width: 11px; height: 11px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .duty-dot.on { background: #27ae60; }
    .duty-dot.off { background: #e74c3c; }
    .shift-label { border-radius: 5px; padding: 2px 7px; color: #fff; font-weight: 600; font-size: 0.99em; }
    .shift-morning { background: #2a5298; }
    .shift-afternoon { background: #f39c12; }
    .shift-night { background: #22223b; }
    @media (max-width: 1000px) {
      .main-content { padding: 0.5rem;}
      .dashboard-metrics { flex-direction: column; gap: 1rem; }
      .guards-table th, .guards-table td, .users-table th, .users-table td, .incidents-table th, .incidents-table td, .logs-table th, .logs-table td { padding: 7px 3px; font-size: 0.97rem;}
    }
    
    /* Notification styles */
    #notification-area {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      max-width: 340px;
      pointer-events: none;
    }
    .notification {
      background: #274472;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #15223855;
      padding: 1rem 1.2rem;
      margin-bottom: 0.7rem;
      font-size: 1.08rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(30px);
      animation: notif-in 0.5s forwards, notif-out 0.5s 3.5s forwards;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }
    .notification.success { background: #27ae60; }
    .notification.error { background: #e74c3c; }
    .notification.info { background: #274472; }
    @keyframes notif-in {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @keyframes notif-out {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar">
       <img src="Bold Emblem Logo for Sagittarius Security (1).png"  alt="Logo" class="logo-img" style="width:50%;height:auto;margin-bottom:1.5rem;align-left"/>
          
      <h2 class="sidebar-title">Sagittarius Security</h2>
      <ul class="sidebar-links">
        <li><span class="sidebar-link active" data-section="dashboard">Dashboard</span></li>
        <li><span class="sidebar-link" data-section="incidents">Incident Reporting</span></li>
        <li><span class="sidebar-link" data-section="guards">Guard Tracking</span></li>
        <li><span class="sidebar-link" data-section="users">User Management</span></li>
        <li><span class="sidebar-link" data-section="reports">System Reports</span></li>
      </ul>
    </nav>
    <main class="main-content" id="mainContent"></main>
    <div id="modal-root"></div>
  </div>
   <div id="notification-area"></div>
  </div>
  <script>

     // === Notification System ===
    function notify(msg, type="info") {
      const area = document.getElementById('notification-area');
      const n = document.createElement('div');
      n.className = `notification ${type}`;
      n.innerHTML = `<span>${msg}</span>`;
      area.appendChild(n);
      setTimeout(() => {
        n.style.opacity = 0;
        setTimeout(() => area.removeChild(n), 600);
      }, 4000);
    }

    // --- Data Layer ---
    function getUsers() { return JSON.parse(localStorage.getItem("sagittarius-users") || "[]"); }
    function getGuards() { return JSON.parse(localStorage.getItem("sagittarius-guards") || "[]"); }
    function getIncidents() { return JSON.parse(localStorage.getItem("sagittarius-incidents") || "[]"); }
    function getLogs() { return JSON.parse(localStorage.getItem("sagittarius-logs") || "[]"); }
    function saveUsers(users) { localStorage.setItem("sagittarius-users", JSON.stringify(users)); }
    function saveGuards(guards) { localStorage.setItem("sagittarius-guards", JSON.stringify(guards)); }
    function saveIncidents(incidents) { localStorage.setItem("sagittarius-incidents", JSON.stringify(incidents)); }
    function saveLogs(logs) { localStorage.setItem("sagittarius-logs", JSON.stringify(logs)); }
    function addLog(action) {
      const logs = getLogs();
      logs.unshift({action, timestamp: getNowTimestamp()});
      saveLogs(logs);
    }
    function getNowTimestamp() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = now.getFullYear();
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }
    function escapeHTML(str) {
      return String(str || '').replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }
    function arrayToCsv(data, columns) {
      const esc = v => `"${String(v === undefined ? "" : v).replace(/"/g, '""')}"`;
      let header = columns.map(c => esc(c.label)).join(',');
      let rows = data.map(row => columns.map(c => esc(row[c.key])).join(','));
      return [header, ...rows].join('\r\n');
    }
    function downloadCsv(filename, csv) {
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }
    // --- Demo Data Initialization ---
    if (!localStorage.getItem("sagittarius-users")) {
      saveUsers([
        {id:"1001", name:"Admin", address:"HQ Road", email:"admin@demo.com", phone:"1234567890", role:"Administrator", department:"IT", location:"HQ"}
      ]);
    }
    if (!localStorage.getItem("sagittarius-guards")) {
      saveGuards([
        { name: "John Doe", phone: "08031234567", shift: "Morning", duty: "on", location: "HQ 1", lat: 6.5244, lng: 3.3792 },
        { name: "Jane Smith", phone: "08035554444", shift: "Night", duty: "off", location: "HQ 2", lat: 6.5987, lng: 3.3991 },
        { name: "Mike Kelvin", phone: "08031112222", shift: "Afternoon", duty: "on", location: "HQ 1", lat: 6.4551, lng: 3.3841 }
      ]);
    }
    if (!localStorage.getItem("sagittarius-incidents")) {
      saveIncidents([
        {title:"Gate Breach", description:"Unauthorized entry detected", location:"Gate 1", reporter:"Jane Smith", date:"2025-09-14", time:"15:30"}
      ]);
    }
    if (!localStorage.getItem("sagittarius-logs")) {
      saveLogs([{action:"System initialized",timestamp:getNowTimestamp()}]);
    }
    // --- Utility ---
    function getUniqueLocations() {
      const userLocs = getUsers().map(u => (u.location || '').trim()).filter(Boolean);
      const guardLocs = getGuards().map(g => {
        if(g.location && g.location.trim()) return g.location.trim();
        if(g.lat && g.lng) return `${g.lat.toFixed(4)},${g.lng.toFixed(4)}`;
        return '';
      }).filter(Boolean);
      return Array.from(new Set([...userLocs, ...guardLocs]));
    }
    // --- Navigation ---
    function showSection(section) {
      const main = document.getElementById('mainContent');
      while(main.firstChild) main.removeChild(main.firstChild);
      document.getElementById('modal-root').innerHTML = '';
      if(section==='dashboard') renderDashboard();
      if(section==='incidents') renderIncidentReporting();
      if(section==='guards') renderGuardTracking();
      if(section==='users') renderUserManagement();
      if(section==='reports') renderReports();
    }
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', function() {
        document.querySelectorAll('.sidebar-link').forEach(l=>l.classList.remove('active'));
        this.classList.add('active');
        showSection(this.getAttribute('data-section'));
      });
    });

    // --- Dashboard with Trend and Bar Chart ---
    function renderDashboard() {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="dashboard-header">
          <h1>Dashboard</h1>
          <div class="timestamp">&#128337; <span id="dashboardTimestamp"></span></div>
        </div>
        <div class="dashboard-metrics" id="dashboardMetrics"></div>
        <div class="chart-section">
          <div class="chart-title">Incident Reports Trend by Month</div>
          <canvas id="incidentTrendChart" height="80"></canvas>
        </div>
        <div class="chart-section">
          <div class="chart-title">Number of Unique Locations by Month (from Incidents)</div>
          <canvas id="locationBarChart" height="90"></canvas>
        </div>
      `;
      function renderMetrics() {
        const users = getUsers(), guards = getGuards(), incidents = getIncidents(), locations = getUniqueLocations();
        document.getElementById("dashboardMetrics").innerHTML = `
          <div class="metric-card users">
            <div class="metric-value">${users.length}</div>
            <div class="metric-label">Total Users</div>
          </div>
          <div class="metric-card guards">
            <div class="metric-value">${guards.length}</div>
            <div class="metric-label">Total Guards</div>
          </div>
          <div class="metric-card locations">
            <div class="metric-value">${locations.length}</div>
            <div class="metric-label">Total Locations</div>
          </div>
          <div class="metric-card incidents">
            <div class="metric-value">${incidents.length}</div>
            <div class="metric-label">Total Incidents</div>
          </div>
        `;
      }
      function updateDashboardTimestamp() {
        document.getElementById('dashboardTimestamp').textContent = getNowTimestamp();
      }
      renderMetrics();
      updateDashboardTimestamp();
      setInterval(updateDashboardTimestamp, 1000);
      renderDashboardCharts();
    }
    function renderDashboardCharts() {
      // --- Incident Trend Line Chart ---
      const incidents = getIncidents();
      // Group incidents by YYYY-MM
      const monthlyCount = {};
      incidents.forEach(i => {
        const key = (i.date || "").slice(0,7) || "Unknown";
        monthlyCount[key] = (monthlyCount[key]||0) + 1;
      });
      // Sort months chronologically (take the last 12 months)
      const months = Object.keys(monthlyCount).filter(m=>m!=="Unknown").sort();
      const displayMonths = months.slice(-12);
      const incidentCounts = displayMonths.map(m=>monthlyCount[m]);
      if(displayMonths.length === 0) {
        const now = new Date();
        const m = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
        displayMonths.push(m);
        incidentCounts.push(0);
      }
      const monthLabels = displayMonths.map(m=> {
        const [y,mo] = m.split('-');
        return `${mo}/${y}`;
      });
      const ctx1 = document.getElementById('incidentTrendChart').getContext('2d');
      if(window._incidentTrendChart) window._incidentTrendChart.destroy();
      window._incidentTrendChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Incidents',
            data: incidentCounts,
            fill: true,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231,76,60,0.08)',
            pointBackgroundColor: '#e74c3c'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            title: {display: false}
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
          }
        }
      });

      // --- Locations by Month Bar Chart (number of unique locations each month from incidents) ---
      const locMonthMap = {};
      incidents.forEach(i => {
        const month = (i.date || "").slice(0,7) || "Unknown";
        if(!locMonthMap[month]) locMonthMap[month] = new Set();
        if(i.location && i.location.trim()) locMonthMap[month].add(i.location.trim());
      });
      const locMonths = Object.keys(locMonthMap).filter(m=>m!=="Unknown").sort().slice(-12);
      const locMonthCounts = locMonths.map(m=>locMonthMap[m].size);
      const locMonthLabels = locMonths.map(m=> {
        const [y,mo] = m.split('-');
        return `${mo}/${y}`;
      });
      const ctx2 = document.getElementById('locationBarChart').getContext('2d');
      if(window._locationBarChart) window._locationBarChart.destroy();
      window._locationBarChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: locMonthLabels.length ? locMonthLabels : ['-'],
          datasets: [{
            label: 'Unique Locations',
            data: locMonthCounts.length ? locMonthCounts : [0],
            backgroundColor: '#2a5298'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            title: {display: false}
          },
          scales: {
            y: { beginAtZero: true, stepSize: 1, precision: 0 }
          }
        }
      });
    }

    // --- Incident Reporting ---
    function renderIncidentReporting() {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="dashboard-header">
          <h1>Incident Reporting</h1>
          <div class="timestamp">&#128337; <span id="incidentTimestamp"></span></div>
        </div>
        <button style="margin-bottom:1rem;background:#27ae60;color:#fff;font-weight:600;" onclick="openIncidentModal()">+ Report Incident</button>
        <div id="incidentReportsList"></div>
      `;
      function renderIncidentList() {
        const incidents = getIncidents();
        const listDiv = document.getElementById('incidentReportsList');
        if (!listDiv) return;
        if (incidents.length === 0) {
          listDiv.innerHTML = "<p style='color:#888;'>No incidents reported yet.</p>";
          return;
        }
        let table = `<table class="incidents-table"><thead>
          <tr><th>Title</th><th>Description</th><th>Location</th><th>Reporter</th><th>Date</th><th>Time</th><th>Actions</th></tr>
          </thead><tbody>`;
        incidents.forEach((r, idx) => {
          table += `<tr>
            <td>${escapeHTML(r.title)}</td>
            <td>${escapeHTML(r.description)}</td>
            <td>${escapeHTML(r.location)}</td>
            <td>${escapeHTML(r.reporter)}</td>
            <td>${escapeHTML(r.date)}</td>
            <td>${escapeHTML(r.time)}</td>
            <td>
              <div class="action-btns">
                <button class="btn-action edit" onclick="editIncident(${idx})">Edit</button>
                <button class="btn-action delete" onclick="deleteIncident(${idx})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
        table += `</tbody></table>`;
        listDiv.innerHTML = table;
      }
      function updateIncidentTimestamp() {
        document.getElementById('incidentTimestamp').textContent = getNowTimestamp();
      }
      renderIncidentList();
      updateIncidentTimestamp();
      setInterval(updateIncidentTimestamp, 1000);
      window.openIncidentModal = function(idx) {
        const incidents = getIncidents();
        const isEdit = typeof idx === "number";
        const i = isEdit ? {...incidents[idx]} : {title:"",description:"",location:"",reporter:"",date:"",time:""};
        document.getElementById("modal-root").innerHTML = `
          <div class="modal-bg" id="incidentModalBg">
            <form class="modal" id="incidentModalForm">
              <h2>${isEdit ? "Edit Incident" : "Report Incident"}</h2>
              <div class="form-error" id="incidentModalErr"></div>
              <label>Title*</label>
              <input name="title" value="${escapeHTML(i.title)}" required/>
              <label>Description*</label>
              <textarea name="description" required>${escapeHTML(i.description)}</textarea>
              <label>Location*</label>
              <input name="location" value="${escapeHTML(i.location)}" required/>
              <label>Reporter*</label>
              <input name="reporter" value="${escapeHTML(i.reporter)}" required/>
              <label>Date*</label>
              <input type="date" name="date" value="${escapeHTML(i.date)}" required/>
              <label>Time*</label>
              <input type="time" name="time" value="${escapeHTML(i.time)}" required/>
              <div class="modal-actions">
                <button type="button" class="cancel" onclick="closeModal()">Cancel</button>
                <button type="submit">${isEdit?"Save":"Submit"}</button>
              </div>
            </form>
          </div>
        `;
        document.body.style.overflow = 'hidden';
        document.getElementById("incidentModalForm").onsubmit = function(e) {
          e.preventDefault();
          const f = e.target;
          const incObj = {
            title: f.title.value.trim(),
            description: f.description.value.trim(),
            location: f.location.value.trim(),
            reporter: f.reporter.value.trim(),
            date: f.date.value,
            time: f.time.value
          };
          if (Object.values(incObj).some(v=>!v)) {
            document.getElementById('incidentModalErr').textContent = "All fields required";
            return;
          }
          if (isEdit) incidents[idx] = incObj;
          else incidents.unshift(incObj);
          saveIncidents(incidents);
          closeModal();
          renderIncidentList();
        };
        document.getElementById("incidentModalBg").onclick = function(e) {
          if (e.target.id === "incidentModalBg") closeModal();
        };
      };
      window.editIncident = function(idx) { openIncidentModal(idx); };
      window.deleteIncident = function(idx) {
        if (!confirm("Delete this incident?")) return;
        const incidents = getIncidents();
        incidents.splice(idx,1);
        saveIncidents(incidents);
        renderIncidentList();
      };
      window.closeModal = function() {
        document.getElementById("modal-root").innerHTML = "";
        document.body.style.overflow = "";
      };
    }

    // --- Guard Tracking ---
    function renderGuardTracking() {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="dashboard-header">
          <h1>Guard Tracking</h1>
          <div class="timestamp">&#128337; <span id="guardTimestamp"></span></div>
        </div>
        <button class="btn-action shift" onclick="openGuardModal()">+ Add Guard</button>
        <div id="guardsTable"></div>
      `;
      function shiftClass(shift) {
        if (shift === "Morning") return "shift-morning";
        if (shift === "Afternoon") return "shift-afternoon";
        return "shift-night";
      }
      function renderGuardsTable() {
        const guards = getGuards();
        let html = `<table class="guards-table">
          <thead><tr>
            <th>Name</th><th>Phone</th><th>Shift</th><th>Duty</th><th>Location</th><th>Map</th><th>Actions</th>
          </tr></thead><tbody>
          ${guards.map((g,i)=>`
            <tr>
              <td>${g.name}</td>
              <td><a href="tel:${g.phone}">${g.phone}</a></td>
              <td>
                <span class="shift-label ${shiftClass(g.shift)}">${g.shift||"-"}</span>
              </td>
              <td>
                <span class="duty-dot ${g.duty==="on"?"on":"off"}"></span>
                <b style="color:${g.duty==="on"?"#27ae60":"#e74c3c"}">${g.duty==="on"?"On Duty":"Off Duty"}</b>
              </td>
              <td>${g.location ? g.location : (g.lat && g.lng ? `${g.lat.toFixed(4)}, ${g.lng.toFixed(4)}` : "-")}</td>
              <td>
                <div id="map${i}" class="leaflet-container"></div>
              </td>
              <td>
                <div class="action-btns">
                  <button class="btn-action edit" onclick="openGuardModal(${i})">Edit</button>
                  <button class="btn-action duty-${g.duty}" onclick="toggleDuty(${i})">${g.duty==="on"?"Off Duty":"On Duty"}</button>
                  <button class="btn-action delete" onclick="deleteGuard(${i})">Delete</button>
                </div>
              </td>
            </tr>
          `).join("")}
          </tbody></table>`;
        document.getElementById("guardsTable").innerHTML = html;
      }
      function updateGuardTimestamp() {
        document.getElementById('guardTimestamp').textContent = getNowTimestamp();
      }
      renderGuardsTable();
      updateGuardTimestamp();
      setInterval(updateGuardTimestamp, 1000);
      window.openGuardModal = function(idx) {
        const guards = getGuards();
        const isEdit = typeof idx === "number";
        const g = isEdit ? {...guards[idx]} : { name: "", phone: "", shift: "Morning", duty: "off", location: "", lat: "", lng: "" };
        document.getElementById("modal-root").innerHTML = `
          <div class="modal-bg" id="guardModalBg">
            <form class="modal" id="guardModalForm">
              <h2>${isEdit ? "Edit Guard" : "Add Guard"}</h2>
              <div class="form-error" id="guardModalErr"></div>
              <label>Name*</label>
              <input name="name" value="${g.name||""}" required/>
              <label>Phone*</label>
              <input name="phone" value="${g.phone||""}" required/>
              <label>Shift*</label>
              <select name="shift" required>
                <option value="Morning"${g.shift==="Morning"?" selected":""}>Morning</option>
                <option value="Afternoon"${g.shift==="Afternoon"?" selected":""}>Afternoon</option>
                <option value="Night"${g.shift==="Night"?" selected":""}>Night</option>
              </select>
              <label>Duty*</label>
              <select name="duty" required>
                <option value="on"${g.duty==="on"?" selected":""}>On Duty</option>
                <option value="off"${g.duty==="off"?" selected":""}>Off Duty</option>
              </select>
              <label>Location</label>
              <input name="location" value="${g.location||""}" placeholder="eg. HQ 1"/>
              <label>Latitude</label>
              <input name="lat" type="number" value="${g.lat||""}" placeholder="eg. 6.5244" step="any"/>
              <label>Longitude</label>
              <input name="lng" type="number" value="${g.lng||""}" placeholder="eg. 3.3792" step="any"/>
              <div class="modal-actions">
                <button type="button" class="cancel" onclick="closeModal()">Cancel</button>
                <button type="submit">${isEdit?"Save":"Add"}</button>
              </div>
            </form>
          </div>
        `;
        document.body.style.overflow = "hidden";
        document.getElementById("guardModalForm").onsubmit = function(e) {
          e.preventDefault();
          const f = e.target;
          const newGuard = {
            name: f.name.value.trim(),
            phone: f.phone.value.trim(),
            shift: f.shift.value,
            duty: f.duty.value,
            location: f.location.value.trim(),
            lat: f.lat.value ? parseFloat(f.lat.value) : "",
            lng: f.lng.value ? parseFloat(f.lng.value) : ""
          };
          if (!newGuard.name || !newGuard.phone) {
            document.getElementById("guardModalErr").textContent = "Name and phone required.";
            return;
          }
          if (isEdit) {
            guards[idx] = newGuard;
          } else {
            guards.push(newGuard);
          }
          saveGuards(guards);
          closeModal();
          renderGuardsTable();
        };
        document.getElementById("guardModalBg").onclick = function(e) {
          if (e.target.id === "guardModalBg") closeModal();
        };
      };
      window.toggleDuty = function(idx) {
        const guards = getGuards();
        guards[idx].duty = guards[idx].duty === "on" ? "off" : "on";
        saveGuards(guards);
        renderGuardsTable();
      };
      window.deleteGuard = function(idx) {
        if (!confirm("Delete this guard?")) return;
        const guards = getGuards();
        guards.splice(idx,1);
        saveGuards(guards);
        renderGuardsTable();
      };
      window.closeModal = function() {
        document.getElementById("modal-root").innerHTML = "";
        document.body.style.overflow = "";
      };
    }

    // --- User Management ---
    function renderUserManagement() {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="dashboard-header">
          <h1>User Management</h1>
          <div class="timestamp">&#128337; <span id="userTimestamp"></span></div>
        </div>
        <button style="margin-bottom:1rem;background:#27ae60;color:#fff;font-weight:600;" onclick="openUserModal()">+ Add User</button>
        <div id="usersList"></div>
      `;
      function renderUsersList() {
        const users = getUsers();
        let table = `<table class="users-table"><thead>
          <tr><th>ID</th><th>Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Role</th><th>Dept</th><th>Location</th><th>Actions</th></tr>
          </thead><tbody>`;
        users.forEach((u, idx) => {
          table += `<tr>
            <td>${escapeHTML(u.id)}</td>
            <td>${escapeHTML(u.name)}</td>
            <td>${escapeHTML(u.address)}</td>
            <td>${escapeHTML(u.email)}</td>
            <td>${escapeHTML(u.phone)}</td>
            <td>${escapeHTML(u.role)}</td>
            <td>${escapeHTML(u.department)}</td>
            <td>${escapeHTML(u.location)}</td>
            <td>
              <div class="action-btns">
                <button class="btn-action edit" onclick="editUser(${idx})">Edit</button>
                <button class="btn-action delete" onclick="deleteUser(${idx})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
        table += `</tbody></table>`;
        document.getElementById("usersList").innerHTML = table;
      }
      function updateUserTimestamp() {
        document.getElementById('userTimestamp').textContent = getNowTimestamp();
      }
      renderUsersList();
      updateUserTimestamp();
      setInterval(updateUserTimestamp, 1000);
      window.openUserModal = function(idx) {
        const users = getUsers();
        const isEdit = typeof idx === "number";
        const u = isEdit ? {...users[idx]} : {id: String(1000+users.length+1), name:"", address:"", email:"", phone:"", role:"", department:"", location:""};
        document.getElementById("modal-root").innerHTML = `
          <div class="modal-bg" id="userModalBg">
            <form class="modal" id="userModalForm">
              <h2>${isEdit ? "Edit User" : "Add User"}</h2>
              <div class="form-error" id="userModalErr"></div>
              <label>ID</label>
              <input type="text" name="id" value="${escapeHTML(u.id)}" readonly style="background:#e9edf6;font-weight:bold;" />
              <label>Name*</label>
              <input type="text" name="name" required maxlength="80" value="${escapeHTML(u.name)}"/>
              <label>Address*</label>
              <input type="text" name="address" required maxlength="120" value="${escapeHTML(u.address)}"/>
              <label>Email*</label>
              <input type="email" name="email" required maxlength="80" value="${escapeHTML(u.email)}"/>
              <label>Phone*</label>
              <input type="tel" name="phone" required maxlength="30" value="${escapeHTML(u.phone)}"/>
              <label>Role*</label>
              <input type="text" name="role" required maxlength="30" value="${escapeHTML(u.role)}"/>
              <label>Department*</label>
              <input type="text" name="department" required maxlength="30" value="${escapeHTML(u.department)}"/>
              <label>Location*</label>
              <input type="text" name="location" required maxlength="60" value="${escapeHTML(u.location)}"/>
              <div class="modal-actions">
                <button type="button" class="cancel" onclick="closeModal()">Cancel</button>
                <button type="submit">${isEdit ? "Save" : "Add"}</button>
              </div>
            </form>
          </div>
        `;
        document.body.style.overflow = 'hidden';
        document.getElementById("userModalForm").onsubmit = function(e) {
          e.preventDefault();
          const f = e.target;
          const userObj = {
            id: f.id.value.trim(),
            name: f.name.value.trim(),
            address: f.address.value.trim(),
            email: f.email.value.trim(),
            phone: f.phone.value.trim(),
            role: f.role.value.trim(),
            department: f.department.value.trim(),
            location: f.location.value.trim()
          };
          if (Object.values(userObj).some(v=>!v)) {
            document.getElementById('userModalErr').textContent = "All fields required";
            return;
          }
          if (isEdit) users[idx] = userObj;
          else users.push(userObj);
          saveUsers(users);
          closeModal();
          renderUsersList();
        };
        document.getElementById("userModalBg").onclick = function(e) {
          if (e.target.id === "userModalBg") closeModal();
        };
      };
      window.editUser = function(idx) { openUserModal(idx); };
      window.deleteUser = function(idx) {
        if (!confirm("Delete this user?")) return;
        const users = getUsers();
        users.splice(idx,1);
        saveUsers(users);
        renderUsersList();
      };
      window.closeModal = function() {
        document.getElementById("modal-root").innerHTML = "";
        document.body.style.overflow = "";
      };
    }

    // --- System Reports ---
    function renderReports() {
      const main = document.getElementById('mainContent');
      const inc = getIncidents(), users = getUsers(), logs = getLogs(), guards = getGuards();
      main.innerHTML = `
        <div class="dashboard-header">
          <h1>System Reports</h1>
          <div class="timestamp">&#128337; <span id="reportTimestamp"></span></div>
        </div>
        <div id="reportDownloadBtns"></div>
        <div id="reportTables"></div>
      `;
      document.getElementById("reportDownloadBtns").innerHTML = `
        <button class="report-download-btn" onclick='downloadCsv("incidents.csv",arrayToCsv(${JSON.stringify(inc)},[
          {label:"Title",key:"title"},{label:"Description",key:"description"},{label:"Location",key:"location"},
          {label:"Reporter",key:"reporter"},{label:"Date",key:"date"},{label:"Time",key:"time"}]))'>Download Incidents (.csv)</button>
        <button class="report-download-btn" onclick='downloadCsv("users.csv",arrayToCsv(${JSON.stringify(users)},[
          {label:"ID",key:"id"},{label:"Name",key:"name"},{label:"Address",key:"address"},{label:"Email",key:"email"},
          {label:"Phone",key:"phone"},{label:"Role",key:"role"},{label:"Dept",key:"department"},{label:"Location",key:"location"}]))'>Download Users (.csv)</button>
        <button class="report-download-btn" onclick='downloadCsv("logs.csv",arrayToCsv(${JSON.stringify(logs)},[
          {label:"Action",key:"action"},{label:"Timestamp",key:"timestamp"}]))'>Download Logs (.csv)</button>
        <button class="report-download-btn" onclick='downloadCsv("guards.csv",arrayToCsv(${JSON.stringify(guards)},[
          {label:"Name",key:"name"},{label:"Phone",key:"phone"},{label:"Location",key:"location"},{label:"Shift",key:"shift"},{label:"Duty",key:"duty"},{label:"Latitude",key:"lat"},{label:"Longitude",key:"lng"}]))'>Download Guards (.csv)</button>
      `;
      document.getElementById("reportTables").innerHTML = `
        <h4 style="margin-top:1.2rem;">Incidents Table</h4>
        <table class="incidents-table">
          <thead><tr><th>Title</th><th>Description</th><th>Location</th><th>Reporter</th><th>Date</th><th>Time</th></tr></thead>
          <tbody>${inc.map(i=>`<tr><td>${i.title}</td><td>${i.description}</td><td>${i.location}</td><td>${i.reporter}</td><td>${i.date}</td><td>${i.time}</td></tr>`).join("")}</tbody>
        </table>
        <h4 style="margin-top:1.2rem;">Users Table</h4>
        <table class="users-table">
          <thead><tr><th>ID</th><th>Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Role</th><th>Dept</th><th>Location</th></tr></thead>
          <tbody>${users.map(u=>`<tr><td>${u.id}</td><td>${u.name}</td><td>${u.address}</td><td>${u.email}</td><td>${u.phone}</td><td>${u.role}</td><td>${u.department}</td><td>${u.location}</td></tr>`).join("")}</tbody>
        </table>
        <h4 style="margin-top:1.2rem;">Guards Table</h4>
        <table class="guards-table">
          <thead><tr><th>Name</th><th>Phone</th><th>Location</th><th>Shift</th><th>Duty</th><th>Latitude</th><th>Longitude</th></tr></thead>
          <tbody>${guards.map(g=>`<tr><td>${g.name}</td><td>${g.phone}</td><td>${g.location}</td><td>${g.shift}</td><td>${g.duty}</td><td>${g.lat}</td><td>${g.lng}</td></tr>`).join("")}</tbody>
        </table>
        <h4 style="margin-top:1.2rem;">Logs</h4>
        <table class="logs-table">
          <thead><tr><th>Action</th><th>Timestamp</th></tr></thead>
          <tbody>${logs.map(l=>`<tr><td>${l.action}</td><td>${l.timestamp}</td></tr>`).join("")}</tbody>
        </table>
      `;
      function updateReportTimestamp() {
        document.getElementById('reportTimestamp').textContent = getNowTimestamp();
      }
      updateReportTimestamp();
      setInterval(updateReportTimestamp, 1000);
    }
    // --- Initial Load ---
    renderDashboard();
  </script>
</body>
</html>



