<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Sagittarius Security Management System</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f6f8fa; }
    .container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 240px; background: #152238; color: #fff; display: flex; flex-direction: column;
      padding: 2rem 1rem; min-height: 100vh;
    }
    .sidebar-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 2.5rem; text-align: center; }
    .sidebar-links { list-style: none; padding: 0; margin: 0; }
    .sidebar-link {
      display: block; color: #c8d1e1; padding: 0.9rem 1.2rem; border-radius: 0.4rem;
      text-decoration: none; margin-bottom: 0.7rem; font-size: 1.06rem;
      transition: background 0.2s, color 0.2s; cursor: pointer;
    }
    .sidebar-link.active, .sidebar-link:hover { background: #274472; color: #fff; }
    .main-content { flex: 1; padding: 2rem; background: #f6f8fa; overflow-y: auto; position: relative; }
    .dashboard-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; gap: 1.5rem;
    }
    .dashboard-header h1 { margin: 0; }
    .timestamp {
      color: #274472; font-size: 1.02rem; background: #e9edf6;
      padding: 0.35rem 0.9rem; border-radius: 1.2rem; box-shadow: 0 2px 8px rgba(30,40,55,0.05);
      font-weight: 500; display: inline-flex; align-items: center; gap: 0.4rem;
      margin-bottom: 1rem;
    }
    .dashboard-metrics {
      display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap;
    }
    .metric-card {
      box-shadow: 0 2px 8px rgba(30,40,55,0.08); border-radius: 0.8rem; padding: 1.1rem 1.6rem; flex: 1 1 160px;
      min-width: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff;
    }
    .metric-card.users { background: linear-gradient(135deg, #2a5298 60%, #1e3c72 100%); }
    .metric-card.guards { background: linear-gradient(135deg, #27ae60 60%, #219150 100%); }
    .metric-card.locations { background: linear-gradient(135deg, #f39c12 60%, #e67e22 100%); }
    .metric-card.incidents { background: linear-gradient(135deg, #e74c3c 60%, #c0392b 100%); }
    .metric-value { font-size: 1.6rem; font-weight: bold; margin-bottom: 0.2rem; }
    .metric-label { font-size: 0.99rem; color: rgba(255,255,255,0.9); }
    .users-table, .incidents-table, .logs-table {
      width: 100%; border-collapse: collapse; margin-top: 1.2rem; background: #fff; box-shadow: 0 2px 8px #e3e7ef;
      border-radius: 9px; overflow: hidden; font-size: 1.01rem;
    }
    .users-table thead, .incidents-table thead, .logs-table thead { background: #f6f8fa; color: #274472; }
    .users-table th, .users-table td, .incidents-table th, .incidents-table td, .logs-table th, .logs-table td {
      padding: 8px 10px; border-bottom: 1px solid #e3e7ef; text-align: left;
    }
    .users-table th, .incidents-table th, .logs-table th { font-weight: 600; }
    .users-table tr:last-child td, .incidents-table tr:last-child td, .logs-table tr:last-child td { border-bottom: none; }
    .users-table tbody tr:hover, .incidents-table tbody tr:hover, .logs-table tbody tr:hover { background: #f9f2f2; }
    .users-table .action-btns, .incidents-table .action-btns { display: flex; gap: 7px; }
    .users-table .btn-action, .incidents-table .btn-action {
      border: none; background: #e9edf6; color: #274472; padding: 4px 11px; border-radius: 4px;
      cursor: pointer; font-size: 0.98rem; font-weight: 600;
      transition: background 0.16s, color 0.16s;
    }
    .users-table .btn-action.view, .incidents-table .btn-action.view { background: #4d79ff; color: #fff; }
    .users-table .btn-action.edit, .incidents-table .btn-action.edit { background: #f39c12; color: #fff; }
    .users-table .btn-action.delete, .incidents-table .btn-action.delete { background: #e74c3c; color: #fff; }
    .users-table .btn-action.call { background: #27ae60; color: #fff; }
    .users-table .btn-action:active, .incidents-table .btn-action:active, .users-table .btn-action.call:active { opacity: 0.8; }
    .report-download-btn {
      background: #274472; color: #fff; border: none; border-radius: 5px; padding: 7px 16px; font-size: 1.02rem;
      margin-bottom: 1.2rem; margin-right: 10px; cursor: pointer; font-weight: 600; transition: background 0.16s;
    }
    .report-download-btn:hover { background: #2a5298; }
    .map-placeholder {
      background: #e3e7ef;
      border-radius: 10px;
      width: 100%;
      min-height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #274472;
    }
    /* Modal styles */
    .modal-bg {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,40,55,0.23); z-index: 99; display: flex; align-items: center; justify-content: center;
      animation: fade-in-bg 0.2s;
    }
    @keyframes fade-in-bg { from { opacity: 0; } to { opacity: 1; } }
    .modal {
      background: #fff; border-radius: 1rem; box-shadow: 0 8px 36px rgba(30,40,55,0.14);
      padding: 2rem 2rem 1.5rem 2rem; max-width: 400px; width: 98vw; position: relative;
      animation: fade-in-modal 0.2s; max-height: 90vh; overflow-y: auto; overscroll-behavior: contain;
    }
    @keyframes fade-in-modal {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .modal h2 { margin-top: 0; font-size: 1.28rem; color: #274472; }
    .modal label {
      font-weight: 500; display: block; margin: 1rem 0 0.12rem 0; color: #274472;
    }
    .modal input, .modal textarea, .modal select {
      width: 100%; padding: 7px 8px; border-radius: 5px; border: 1px solid #c8d1e1; font-size: 1.04rem;
      margin-bottom: 0.3rem; box-sizing: border-box; background: #f6f8fa; resize: vertical;
    }
    .modal input[type="file"] { background: #fff; border: none; margin-bottom: 0.9rem; }
    .modal .modal-actions {
      display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;
    }
    .modal .modal-actions button {
      padding: 8px 20px; border-radius: 5px; border: none; font-size: 1.05rem;
      background: #274472; color: #fff; cursor: pointer; transition: background 0.18s;
    }
    .modal .modal-actions button.cancel { background: #bbb; color: #274472; }
    .modal .modal-actions button:active { opacity: 0.8; }
    .modal .form-error { color: #e74c3c; font-size: 0.98rem; margin-bottom: 0.4rem; margin-top: 0.2rem; }
    .modal .modal-close {
      position: absolute; top: 0.7rem; right: 1.1rem; font-size: 1.3rem; color: #274472;
      background: none; border: none; cursor: pointer;
    }
    @media (max-width: 1000px) {
      .main-content { padding: 0.5rem; }
      .module-card { min-width: 95vw; max-width: 98vw; }
      .dashboard-metrics { flex-direction: column; gap: 1rem; }
      .users-table th, .users-table td, .incidents-table th, .incidents-table td, .logs-table th, .logs-table td { padding: 7px 3px; font-size: 0.97rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar">
      <h2 class="sidebar-title">Sagittarius Security</h2>
      <ul class="sidebar-links">
        <li><span class="sidebar-link active" data-section="dashboard">Interactive Dashboard</span></li>
        <li><span class="sidebar-link" data-section="incidents">Incident Reporting</span></li>
        <li><span class="sidebar-link" data-section="guards">Guard Tracking</span></li>
        <li><span class="sidebar-link" data-section="users">User Management</span></li>
        <li><span class="sidebar-link" data-section="reports">System Reports</span></li>
      </ul>
    </nav>
    <main class="main-content" id="mainContent"></main>
    <div id="modal-root"></div>
  </div>
  <script>
    // --- Data (with localStorage persistence) ---
    let users = JSON.parse(localStorage.getItem("sagittarius-users") || "[]");
    let incidents = JSON.parse(localStorage.getItem("sagittarius-incidents") || "[]");
    let logs = JSON.parse(localStorage.getItem("sagittarius-logs") || "[]");

    // If first time, populate with demo data:
    if (users.length === 0 && incidents.length === 0 && logs.length === 0) {
      users = [
        {id:"1001",name:"Admin",address:"HQ Road",email:"admin@demo.com",phone:"1234567890",role:"Administrator",department:"IT",location:"HQ"},
        {id:"1002",name:"Jane Doe",address:"West Ave",email:"jane@demo.com",phone:"5551234567",role:"Guard",department:"Operation",location:"North Post"}
      ];
      incidents = [
        {title:"Gate Breach",description:"Unauthorized entry detected",location:"Gate 1",reporter:"Jane Doe",date:"2025-09-14",time:"15:30",attachment:""}
      ];
      logs = [{action:"System initialized",timestamp:getNowTimestamp()}];
      localStorage.setItem("sagittarius-users", JSON.stringify(users));
      localStorage.setItem("sagittarius-incidents", JSON.stringify(incidents));
      localStorage.setItem("sagittarius-logs", JSON.stringify(logs));
    }

    // --- Utility Functions (CSV, Logs, Escape, Notification) ---
    function arrayToCsv(data, columns) {
      const esc = v => `"${String(v === undefined ? "" : v).replace(/"/g, '""')}"`;
      let header = columns.map(c => esc(c.label)).join(',');
      let rows = data.map(row => columns.map(c => esc(row[c.key])).join(','));
      return [header, ...rows].join('\r\n');
    }
    function downloadCsv(filename, csv) {
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }
    function addLog(action) {
      logs.push({
        action,
        timestamp: getNowTimestamp()
      });
      localStorage.setItem("sagittarius-logs", JSON.stringify(logs));
    }
    function generateUserID() {
      let max = users.reduce((m, u) => Math.max(m, parseInt(u.id, 10)), 1000);
      return (isNaN(max) ? 1001 : max+1).toString();
    }
    function escapeHTML(str) {
      return String(str || '').replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }
    // --- Shared Table Renderers ---
    function renderUserList(divId = 'usersList') {
      const listDiv = document.getElementById(divId);
      if (!listDiv) return;
      if (users.length === 0) {
        listDiv.innerHTML = "<p style='color:#888;'>No users added yet.</p>";
        return;
      }
      let table = `<table class="users-table"><thead>
        <tr><th>ID</th><th>Full Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Role</th><th>Department</th><th>Location</th><th>Actions</th></tr>
        </thead><tbody>`;
      users.forEach((u, idx) => {
        table += `<tr>
          <td>${escapeHTML(u.id)}</td>
          <td>${escapeHTML(u.name)}</td>
          <td>${escapeHTML(u.address)}</td>
          <td>${escapeHTML(u.email)}</td>
          <td>${escapeHTML(u.phone)}</td>
          <td>${escapeHTML(u.role)}</td>
          <td>${escapeHTML(u.department)}</td>
          <td>${escapeHTML(u.location)}</td>
          <td>
            <div class="action-btns">
              <button class="btn-action call" onclick="callUser('${u.phone}')">Call</button>
              <button class="btn-action view" onclick="viewUser(${idx})">View</button>
              <button class="btn-action edit" onclick="editUser(${idx})">Edit</button>
              <button class="btn-action delete" onclick="deleteUser(${idx})">Delete</button>
            </div>
          </td>
        </tr>`;
      });
      table += `</tbody></table>`;
      listDiv.innerHTML = table;
    }
    window.callUser = function(phone) {
      if (phone && phone.trim()) {
        window.location.href = 'tel:' + encodeURIComponent(phone.trim());
      } else {
        alert('No phone number available for this user.');
      }
    };
    function renderIncidentList(divId = 'incidentReportsList') {
      const listDiv = document.getElementById(divId);
      if (!listDiv) return;
      if (incidents.length === 0) {
        listDiv.innerHTML = "<p style='color:#888;'>No incidents reported yet.</p>";
        return;
      }
      let table = `<table class="incidents-table"><thead>
        <tr><th>Title</th><th>Description</th><th>Location</th><th>Reporter</th><th>Date</th><th>Time</th><th>Attachment</th><th>Actions</th></tr>
        </thead><tbody>`;
      incidents.forEach((r, idx) => {
        table += `<tr>
          <td>${escapeHTML(r.title)}</td>
          <td>${escapeHTML(r.description)}</td>
          <td>${escapeHTML(r.location)}</td>
          <td>${escapeHTML(r.reporter)}</td>
          <td>${escapeHTML(r.date)}</td>
          <td>${escapeHTML(r.time)}</td>
          <td>${r.attachment ? `<a class="attachment-link" href="${r.attachment}" target="_blank">View</a>` : ""}</td>
          <td>
            <div class="action-btns">
              <button class="btn-action view" onclick="viewIncident(${idx})">View</button>
              <button class="btn-action edit" onclick="editIncident(${idx})">Edit</button>
              <button class="btn-action delete" onclick="deleteIncident(${idx})">Delete</button>
            </div>
          </td>
        </tr>`;
      });
      table += `</tbody></table>`;
      listDiv.innerHTML = table;
    }
    function renderLogsList(divId = 'logsList') {
      const listDiv = document.getElementById(divId);
      if (!listDiv) return;
      if (logs.length === 0) {
        listDiv.innerHTML = "<p style='color:#888;'>No logs yet.</p>";
        return;
      }
      let table = `<table class="logs-table"><thead>
        <tr><th>Action</th><th>Timestamp</th></tr>
        </thead><tbody>`;
      logs.forEach(log => {
        table += `<tr><td>${escapeHTML(log.action)}</td><td>${escapeHTML(log.timestamp)}</td></tr>`;
      });
      table += `</tbody></table>`;
      listDiv.innerHTML = table;
    }
    // --- User Modal ---
    function openUserModal(mode = "add", idx = null) {
      const modalRoot = document.getElementById('modal-root');
      let modalTitle = "Add User";
      let submitBtnText = "Submit";
      let user = {
        id: generateUserID(),
        name: "",
        address: "",
        email: "",
        phone: "",
        role: "",
        department: "",
        location: ""
      };
      let disableFields = false;
      if (mode === "edit" && typeof idx === "number") {
        modalTitle = "Edit User";
        submitBtnText = "Save";
        user = {...users[idx]};
      } else if (mode === "view" && typeof idx === "number") {
        modalTitle = "View User";
        user = {...users[idx]};
        disableFields = true;
      }
      modalRoot.innerHTML = `
        <div class="modal-bg" id="userModalBg">
          <form class="modal" id="userModalForm" autocomplete="off">
            <button type="button" class="modal-close" title="Close" id="userModalCloseBtn">&times;</button>
            <h2>${modalTitle}</h2>
            <div class="form-error" id="userModalErr"></div>
            <label>ID</label>
            <input type="text" name="id" value="${escapeHTML(user.id)}" readonly style="background:#e9edf6;font-weight:bold;" />
            <label>Full Name*</label>
            <input type="text" name="name" required maxlength="80" value="${escapeHTML(user.name)}" ${disableFields ? 'readonly' : ''} />
            <label>Residential Address*</label>
            <input type="text" name="address" required maxlength="120" value="${escapeHTML(user.address)}" ${disableFields ? 'readonly' : ''} />
            <label>Email Address*</label>
            <input type="email" name="email" required maxlength="80" value="${escapeHTML(user.email)}" ${disableFields ? 'readonly' : ''} />
            <label>Phone Number*</label>
            <input type="tel" name="phone" required maxlength="30" value="${escapeHTML(user.phone)}" ${disableFields ? 'readonly' : ''} />
            <label>Role*</label>
            <select name="role" required ${disableFields ? 'disabled' : ''}>
              <option value="">Select Role</option>
              <option value="Administrator"${user.role === "Administrator" ? " selected" : ""}>Administrator</option>
              <option value="Operation Manager"${user.role === "Operation Manager" ? " selected" : ""}>Operation Manager</option>
              <option value="Marketing Manager"${user.role === "Marketing Manager" ? " selected" : ""}>Marketing Manager</option>
              <option value="HR Manager"${user.role === "HR Manager" ? " selected" : ""}>HR Manager</option>
              <option value="IT Manager"${user.role === "IT Manager" ? " selected" : ""}>IT Manager</option>
              <option value="Supervisor"${user.role === "Supervisor" ? " selected" : ""}>Supervisor</option>
              <option value="Guard"${user.role === "Guard" ? " selected" : ""}>Guard</option>
              <option value="Safety Manager"${user.role === "Safety Manager" ? " selected" : ""}>Safety Manager</option>
            </select>
            <label>Department*</label>
            <select name="department" required ${disableFields ? 'disabled' : ''}>
              <option value="">Select Department</option>
              <option value="HR"${user.department === "HR" ? " selected" : ""}>HR</option>
              <option value="Operation"${user.department === "Operation" ? " selected" : ""}>Operation</option>
              <option value="Marketing"${user.department === "Marketing" ? " selected" : ""}>Marketing</option>
              <option value="IT"${user.department === "IT" ? " selected" : ""}>IT</option>
              <option value="Safety"${user.department === "Safety" ? " selected" : ""}>Safety</option>
            </select>
            <label>Location*</label>
            <input type="text" name="location" required maxlength="60" value="${escapeHTML(user.location)}" ${disableFields ? 'readonly' : ''} />
            <div class="modal-actions">
              <button type="button" class="cancel" id="userModalCancelBtn">${disableFields ? "Close" : "Cancel"}</button>
              ${disableFields ? "" : `<button type="submit">${submitBtnText}</button>`}
            </div>
          </form>
        </div>
      `;
      document.body.style.overflow = 'hidden';
      function closeModal() {
        modalRoot.innerHTML = "";
        document.body.style.overflow = '';
      }
      document.getElementById('userModalCloseBtn').onclick = closeModal;
      document.getElementById('userModalCancelBtn').onclick = closeModal;
      document.getElementById('userModalBg').onclick = (e) => { if (e.target.id === 'userModalBg') closeModal(); };
      if (!disableFields) {
        document.getElementById('userModalForm').onsubmit = function(e) {
          e.preventDefault();
          const f = e.target;
          const err = document.getElementById('userModalErr');
          err.textContent = "";
          if (!f.name.value.trim() || !f.address.value.trim() || !f.email.value.trim() ||
              !f.phone.value.trim() || !f.role.value.trim() || !f.department.value.trim() || !f.location.value.trim()) {
            err.textContent = "Please fill in all required fields.";
            return;
          }
          if (mode === "add") {
            users.push({
              id: user.id,
              name: f.name.value.trim(),
              address: f.address.value.trim(),
              email: f.email.value.trim(),
              phone: f.phone.value.trim(),
              role: f.role.value,
              department: f.department.value,
              location: f.location.value.trim()
            });
            localStorage.setItem("sagittarius-users", JSON.stringify(users));
            addNotification('New user added.', '👤');
            addLog('User added: ' + f.name.value.trim());
          } else if (mode === "edit" && typeof idx === "number") {
            users[idx] = {
              id: user.id,
              name: f.name.value.trim(),
              address: f.address.value.trim(),
              email: f.email.value.trim(),
              phone: f.phone.value.trim(),
              role: f.role.value,
              department: f.department.value,
              location: f.location.value.trim()
            };
            localStorage.setItem("sagittarius-users", JSON.stringify(users));
            addNotification('User updated.', '✏️');
            addLog('User updated: ' + f.name.value.trim());
          }
          closeModal();
          renderUserList();
          renderUserList("usersListReport");
          const userCount = document.getElementById('total-users');
          if (userCount) userCount.textContent = users.length;
        }
      }
    }
    window.viewUser = function(idx) { openUserModal("view", idx); };
    window.editUser = function(idx) { openUserModal("edit", idx); };
    window.deleteUser = function(idx) {
      if (confirm("Are you sure you want to delete this user?")) {
        addLog('User deleted: ' + users[idx].name);
        users.splice(idx, 1);
        localStorage.setItem("sagittarius-users", JSON.stringify(users));
        addNotification('User deleted.', '🗑️');
        renderUserList();
        renderUserList("usersListReport");
        const userCount = document.getElementById('total-users');
        if (userCount) userCount.textContent = users.length;
      }
    };
    // --- Incident Modal ---
    function openIncidentModal(mode = "add", idx = null) {
      const modalRoot = document.getElementById('modal-root');
      let modalTitle = "Report Incident";
      let submitBtnText = "Submit";
      let incident = {
        title: "",
        description: "",
        location: "",
        reporter: "",
        date: "",
        time: "",
        attachment: ""
      };
      let disableFields = false;
      if (mode === "edit" && typeof idx === "number") {
        modalTitle = "Edit Incident";
        submitBtnText = "Save";
        incident = {...incidents[idx]};
      } else if (mode === "view" && typeof idx === "number") {
        modalTitle = "View Incident";
        incident = {...incidents[idx]};
        disableFields = true;
      }
      modalRoot.innerHTML = `
        <div class="modal-bg" id="incidentModalBg">
          <form class="modal" id="incidentModalForm" autocomplete="off">
            <button type="button" class="modal-close" title="Close" id="incidentModalCloseBtn">&times;</button>
            <h2>${modalTitle}</h2>
            <div class="form-error" id="incidentModalErr"></div>
            <label>Title*</label>
            <input type="text" name="title" required maxlength="120" value="${escapeHTML(incident.title)}" ${disableFields ? 'readonly' : ''}/>
            <label>Description*</label>
            <textarea name="description" required rows="3" maxlength="300" ${disableFields ? 'readonly' : ''}>${escapeHTML(incident.description)}</textarea>
            <label>Location*</label>
            <input type="text" name="location" required maxlength="80" value="${escapeHTML(incident.location)}" ${disableFields ? 'readonly' : ''}/>
            <label>Reporter*</label>
            <input type="text" name="reporter" required maxlength="60" value="${escapeHTML(incident.reporter)}" ${disableFields ? 'readonly' : ''}/>
            <label>Date*</label>
            <input type="date" name="date" required value="${escapeHTML(incident.date)}" ${disableFields ? 'readonly' : ''}/>
            <label>Time*</label>
            <input type="time" name="time" required value="${escapeHTML(incident.time)}" ${disableFields ? 'readonly' : ''}/>
            <label>Attachment</label>
            ${disableFields
              ? (incident.attachment ? `<div style="margin-bottom:1rem"><a class="attachment-link" href="${incident.attachment}" target="_blank">View Attachment</a></div>` : `<div style="margin-bottom:1rem;color:#888">No attachment</div>`)
              : `<input type="file" name="attachment" accept="image/*,.pdf,.doc,.docx,.txt" />`
            }
            <div class="modal-actions">
              <button type="button" class="cancel" id="incidentModalCancelBtn">Close</button>
              ${disableFields ? "" : `<button type="submit">${submitBtnText}</button>`}
            </div>
          </form>
        </div>
      `;
      document.body.style.overflow = 'hidden';
      function closeModal() {
        modalRoot.innerHTML = "";
        document.body.style.overflow = '';
      }
      document.getElementById('incidentModalCloseBtn').onclick = closeModal;
      document.getElementById('incidentModalCancelBtn').onclick = closeModal;
      document.getElementById('incidentModalBg').onclick = (e) => { if (e.target.id === 'incidentModalBg') closeModal(); };
      if (!disableFields) {
        document.getElementById('incidentModalForm').onsubmit = function(e) {
          e.preventDefault();
          const f = e.target;
          const err = document.getElementById('incidentModalErr');
          err.textContent = "";
          if (!f.title.value.trim() || !f.description.value.trim() || !f.location.value.trim() ||
              !f.reporter.value.trim() || !f.date.value || !f.time.value) {
            err.textContent = "Please fill in all required fields.";
            return;
          }
          let attachmentURL = "";
          const file = f.attachment ? f.attachment.files[0] : null;
          if (file) {
            attachmentURL = URL.createObjectURL(file);
          }
          if (mode === "add") {
            incidents.unshift({
              title: f.title.value.trim(),
              description: f.description.value.trim(),
              location: f.location.value.trim(),
              reporter: f.reporter.value.trim(),
              date: f.date.value,
              time: f.time.value,
              attachment: attachmentURL
            });
            localStorage.setItem("sagittarius-incidents", JSON.stringify(incidents));
            addNotification('New incident reported.', '🚨');
            addLog('Incident reported: ' + f.title.value.trim());
          } else if (mode === "edit" && typeof idx === "number") {
            let originalAttachment = incidents[idx].attachment;
            incidents[idx] = {
              title: f.title.value.trim(),
              description: f.description.value.trim(),
              location: f.location.value.trim(),
              reporter: f.reporter.value.trim(),
              date: f.date.value,
              time: f.time.value,
              attachment: attachmentURL || originalAttachment
            };
            localStorage.setItem("sagittarius-incidents", JSON.stringify(incidents));
            addNotification('Incident updated.', '✏️');
            addLog('Incident updated: ' + f.title.value.trim());
          }
          closeModal();
          renderIncidentList();
          renderIncidentList("incidentReportsListReport");
          const incCount = document.getElementById('total-incidents');
          if (incCount) incCount.textContent = incidents.length;
        };
      }
    }
    window.viewIncident = function(idx) { openIncidentModal("view", idx); };
    window.editIncident = function(idx) { openIncidentModal("edit", idx); };
    window.deleteIncident = function(idx) {
      if (confirm("Are you sure you want to delete this incident?")) {
        addLog('Incident deleted: ' + incidents[idx].title);
        incidents.splice(idx, 1);
        localStorage.setItem("sagittarius-incidents", JSON.stringify(incidents));
        addNotification('Incident deleted.', '🗑️');
        renderIncidentList();
        renderIncidentList("incidentReportsListReport");
        const incCount = document.getElementById('total-incidents');
        if (incCount) incCount.textContent = incidents.length;
      }
    };
    // --- Notification logic (bell, panel) ---
    let notifications = [];
    let unseenNotifications = false;
    function addNotification(message, icon) {
      const now = new Date();
      notifications.unshift({
        message,
        icon,
        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        seen: false
      });
      unseenNotifications = true;
      updateNotificationUI();
    }
    function updateNotificationUI() {
      const notificationBell = document.getElementById('notificationBell');
      const notificationsPanel = document.getElementById('notificationsPanel');
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationBell || !notificationsPanel || !notificationsList) return;
      if (unseenNotifications && notifications.length > 0) {
        notificationBell.classList.add('active');
      } else {
        notificationBell.classList.remove('active');
      }
      notificationsList.innerHTML = notifications.length === 0
        ? '<p style="color:#888;padding:1rem 0;">No notifications yet.</p>'
        : notifications.map(n =>
            `<div class="notification-item">
              <span class="notification-icon">${n.icon}</span>
              <span>${n.message}</span>
              <span class="notification-time">${n.time}</span>
            </div>`
          ).join('');
    }
    function setupNotificationBell() {
      const notificationBell = document.getElementById('notificationBell');
      const notificationsPanel = document.getElementById('notificationsPanel');
      if (!notificationBell || !notificationsPanel) return;
      notificationBell.onclick = (e) => {
        notificationsPanel.classList.toggle('visible');
        notifications = notifications.map(n => ({...n, seen: true}));
        unseenNotifications = false;
        updateNotificationUI();
        e.stopPropagation();
      };
      window.addEventListener('click', function(event){
        if (!notificationBell.contains(event.target) && !notificationsPanel.contains(event.target)) {
          notificationsPanel.classList.remove('visible');
        }
      });
    }
    // --- Timestamp ---
    function getNowTimestamp() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = now.getFullYear();
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }
    // --- Guard Tracking Placeholder ---
    function renderGuardTracking() {
      return `
        <div class="map-placeholder">
          <span>Guard map/tracking features placeholder</span>
        </div>
        <ul style="margin:1rem 0 0 0;padding:0;list-style:none;">
          <li>Guard 1 - Active</li>
          <li>Guard 2 - On Duty</li>
          <li>Guard 3 - Off Duty</li>
        </ul>
      `;
    }
    // --- Navigation and Page Rendering ---
    const mainContent = document.getElementById("mainContent");
    const links = document.querySelectorAll('.sidebar-link');
    function renderPage(section) {
      let html = "";
      if (section === "dashboard") {
        html = `
          <div>
            <div class="dashboard-header">
              <h1>Interactive Dashboard</h1>
              <div class="timestamp" id="dashboardTimestamp">&#128337; <span id="timestampText"></span></div>
            </div>
            <div class="dashboard-metrics">
              <div class="metric-card users">
                <div class="metric-value" id="total-users">${users.length}</div>
                <div class="metric-label">Total Users</div>
              </div>
              <div class="metric-card guards">
                <div class="metric-value" id="total-guards">12</div>
                <div class="metric-label">Total Guards</div>
              </div>
              <div class="metric-card locations">
                <div class="metric-value" id="total-locations">5</div>
                <div class="metric-label">Locations</div>
              </div>
              <div class="metric-card incidents">
                <div class="metric-value" id="total-incidents">${incidents.length}</div>
                <div class="metric-label">Incidents</div>
              </div>
            </div>
            <p>Welcome to Sagittarius Security Services Management System!</p>
            <div class="notification-bell" id="notificationBell" title="Notifications"
              style="position:fixed;top:18px;right:38px;z-index:99;">
              <span class="bell-icon">&#128276;</span>
              <span class="bell-dot" id="notificationDot"></span>
            </div>
            <div class="notifications-panel" id="notificationsPanel"
              style="position:fixed;top:60px;right:24px;z-index:100;">
              <div class="notifications-title">Notifications</div>
              <div id="notificationsList"></div>
            </div>
          </div>`;
      }
      if (section === "incidents") {
        html = `
          <div>
            <div class="dashboard-header">
              <h1>Incident Reporting</h1>
              <div class="timestamp" id="dashboardTimestamp">&#128337; <span id="timestampText"></span></div>
            </div>
            <button id="addIncidentBtn" style="margin-bottom:1rem;background:#27ae60;color:#fff;font-weight:600;">+ Report Incident</button>
            <div id="incidentReportsList"></div>
          </div>`;
      }
      if (section === "guards") {
        html = `
          <div>
            <div class="dashboard-header">
              <h1>Guard Tracking</h1>
              <div class="timestamp" id="dashboardTimestamp">&#128337; <span id="timestampText"></span></div>
            </div>
            ${renderGuardTracking()}
          </div>`;
      }
      if (section === "users") {
        html = `
          <div>
            <div class="dashboard-header">
              <h1>User Management</h1>
              <div class="timestamp" id="dashboardTimestamp">&#128337; <span id="timestampText"></span></div>
            </div>
            <button id="addUserBtn" style="margin-bottom:1rem;background:#27ae60;color:#fff;font-weight:600;">+ Add User</button>
            <div id="usersList"></div>
          </div>`;
      }
      if (section === "reports") {
        html = `
          <div>
            <div class="dashboard-header">
              <h1>System Reports</h1>
              <div class="timestamp" id="dashboardTimestamp">&#128337; <span id="timestampText"></span></div>
            </div>
            <div>
              <button class="report-download-btn" id="downloadIncidentsBtn">Download Incidents (.csv)</button>
              <button class="report-download-btn" id="downloadUsersBtn">Download Users (.csv)</button>
              <button class="report-download-btn" id="downloadLogsBtn">Download Logs (.csv)</button>
            </div>
            <h4 style="margin-top:1.2rem;">Incidents Table</h4>
            <div id="incidentReportsListReport"></div>
            <h4 style="margin-top:1.2rem;">Users Table</h4>
            <div id="usersListReport"></div>
            <h4 style="margin-top:1.2rem;">Logs</h4>
            <div id="logsList"></div>
          </div>`;
      }
      mainContent.innerHTML = html;
      // Timestamp update
      function updateTimestamp() {
        const el = document.getElementById('timestampText');
        if (el) el.textContent = getNowTimestamp();
      }
      updateTimestamp();
      setInterval(updateTimestamp, 1000);
      // Setup notification panel if present
      updateNotificationUI();
      setupNotificationBell();
      // Per-page setup
      if (section === "incidents") {
        document.getElementById('addIncidentBtn').onclick = function() { openIncidentModal('add', null); };
        renderIncidentList();
      }
      if (section === "users") {
        document.getElementById("addUserBtn").onclick = function() { openUserModal("add", null); };
        renderUserList();
      }
      if (section === "reports") {
        renderIncidentList("incidentReportsListReport");
        renderUserList("usersListReport");
        renderLogsList();
        document.getElementById('downloadIncidentsBtn').onclick = function() {
          const cols = [
            {label: "Title", key: "title"},
            {label: "Description", key: "description"},
            {label: "Location", key: "location"},
            {label: "Reporter", key: "reporter"},
            {label: "Date", key: "date"},
            {label: "Time", key: "time"},
            {label: "Attachment", key: "attachment"}
          ];
          downloadCsv("incidents.csv", arrayToCsv(incidents, cols));
        };
        document.getElementById('downloadUsersBtn').onclick = function() {
          const cols = [
            {label: "ID", key: "id"},
            {label: "Full Name", key: "name"},
            {label: "Address", key: "address"},
            {label: "Email", key: "email"},
            {label: "Phone", key: "phone"},
            {label: "Role", key: "role"},
            {label: "Department", key: "department"},
            {label: "Location", key: "location"}
          ];
          downloadCsv("users.csv", arrayToCsv(users, cols));
        };
        document.getElementById('downloadLogsBtn').onclick = function() {
          const cols = [
            {label: "Action", key: "action"},
            {label: "Timestamp", key: "timestamp"}
          ];
          downloadCsv("logs.csv", arrayToCsv(logs, cols));
        };
      }
    }
    // Sidebar navigation
    links.forEach(link => {
      link.addEventListener('click', () => {
        links.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        renderPage(link.getAttribute('data-section'));
      });
    });
    // Initial load
    renderPage('dashboard');
  </script>
</body>
</html>
